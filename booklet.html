<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Booklet Maker A3</title>
<style>
  :root {
    color-scheme: light dark;
    --bg: #0f172a;
    --bg-soft: #1e293b;
    --accent: #22c55e;
    --accent-soft: rgba(34, 197, 94, 0.12);
    --accent-strong: rgba(34, 197, 94, 0.22);
    --text: #e5e7eb;
    --text-muted: #9ca3af;
    --border-subtle: rgba(148, 163, 184, 0.35);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
      "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #1f2937, #020617 55%);
    color: var(--text);
    display: flex;
    align-items: stretch;
    justify-content: center;
  }

  .app-shell {
    width: 100%;
    max-width: 640px;
    padding: 16px;
    padding-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .card {
    background: radial-gradient(circle at top, #111827, #020617 60%);
    border-radius: 18px;
    border: 1px solid var(--border-subtle);
    box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
    padding: 18px 16px 14px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  h1 {
    margin: 0;
    font-size: 1.2rem;
    letter-spacing: 0.03em;
    display: flex;
    align-items: center;
    gap: 0.45rem;
  }

  h1 span.badge {
    font-size: 0.7rem;
    padding: 2px 7px;
    border-radius: 999px;
    background: var(--accent-soft);
    border: 1px solid var(--accent-strong);
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .subtitle {
    margin: 0;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .form-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .file-label {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .file-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.9);
    border: 1px dashed rgba(148, 163, 184, 0.7);
  }

  input[type="file"]#file {
    flex: 1;
    max-width: 100%;
    font-size: 0.85rem;
    color: var(--text);
    padding: 10px 14px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), #020617);
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.45);
  }

  input[type="file"]#file::file-selector-button {
    margin: -2px 10px -2px -4px;
    padding: 7px 12px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    cursor: pointer;
  }

  input[type="file"]#file::-webkit-file-upload-button {
    margin: -2px 10px -2px -4px;
    padding: 7px 12px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    cursor: pointer;
  }

  .primary-button {
    margin-top: 4px;
    width: 100%;
    padding: 11px 18px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    font-size: 0.9rem;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    box-shadow: 0 14px 30px rgba(34, 197, 94, 0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
  }

  .primary-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .primary-button:active {
    transform: translateY(1px) scale(0.995);
    box-shadow: 0 10px 20px rgba(34, 197, 94, 0.4);
  }

  .primary-button span.icon {
    font-size: 1.1rem;
  }

  .helper-text {
    margin-top: 2px;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .loading-indicator {
    display: none;
    align-items: center;
    gap: 12px;
    margin-top: 6px;
    padding: 10px 14px;
    border-radius: 16px;
    background: rgba(15, 23, 42, 0.85);
    border: 1px solid var(--border-subtle);
  }

  .loading-indicator.visible {
    display: flex;
  }

  .loading-indicator .spinner {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 3px solid rgba(148, 163, 184, 0.3);
    border-top-color: var(--accent);
    animation: spin 0.9s linear infinite;
  }

  .loading-indicator strong {
    display: block;
    font-size: 0.82rem;
  }

  .loading-indicator span {
    font-size: 0.72rem;
    color: var(--text-muted);
  }

  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 4px;
  }

  .chip {
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px dashed rgba(148, 163, 184, 0.6);
    font-size: 0.72rem;
    color: var(--text-muted);
  }

  .debug-toggle {
    margin-top: 4px;
    font-size: 0.75rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .debug-toggle input {
    accent-color: var(--accent);
  }

  .debug-panel {
    margin-top: 6px;
    display: none;
  }

  .debug-panel.visible {
    display: block;
  }

  textarea {
    width: 100%;
    height: 180px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    background: rgba(15, 23, 42, 0.9);
    color: var(--text);
    padding: 8px 10px;
    font-size: 0.75rem;
    resize: vertical;
  }

  textarea:focus {
    outline: 1px solid var(--accent-soft);
    box-shadow: 0 0 0 1px var(--accent-soft);
  }

  @media (min-width: 640px) {
    .card {
      padding: 20px 20px 16px;
    }

    h1 {
      font-size: 1.3rem;
    }

    .primary-button {
      width: auto;
      align-self: flex-start;
      padding-inline: 22px;
    }
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
<div class="app-shell">
  <div class="card">
    <div>
      <h1>
        Booklet Maker
        <span class="badge">A3 • Client only</span>
      </h1>
      <p class="subtitle">Drop in PDFs to create duplex-friendly A3 booklets.</p>
    </div>

    <div class="form-row">
      <label class="file-label">
        Source PDF files
        <div class="file-input-wrapper">
          <input type="file" id="file" multiple />
        </div>
      </label>

      <button id="go" class="primary-button">
        <span class="icon">➜</span>
        Make booklet PDF
      </button>

      <p class="helper-text">
        Prints as A3 booklet: single-page files pass through as A4, two-page files get a title cover.
      </p>

      <div class="chips">
        <span class="chip">A3 booklet imposition</span>
        <span class="chip">Client-side only</span>
        <span class="chip">Rotates every other sheet</span>
      </div>

      <div
        id="loading-indicator"
        class="loading-indicator"
        role="status"
        aria-live="polite"
      >
        <div class="spinner" aria-hidden="true"></div>
        <div>
          <strong>Processing PDF…</strong>
          <span>This can take a moment for longer documents.</span>
        </div>
      </div>

      <label class="debug-toggle">
        <input type="checkbox" id="toggle-debug" />
        Show debug log
      </label>

      <div id="debug-panel" class="debug-panel">
        <textarea id="errors" placeholder="Debug output"></textarea>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as pdfjs from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.449/+esm';

function debug(msg) {
  const t = document.getElementById('errors');
  if (!t) return;
  t.value += msg + "\n";
}

try {
  debug('Setting workerSrc');
  pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.449/build/pdf.worker.mjs';
} catch (e) {
  debug('WorkerSrc error: ' + e);
}

debug('pdfjs loaded: ' + typeof pdfjs);
const pdfjsLib = pdfjs;

const toggleDebug = document.getElementById('toggle-debug');
const debugPanel = document.getElementById('debug-panel');
const goButton = document.getElementById('go');
const loadingIndicator = document.getElementById('loading-indicator');

function setLoading(active) {
  if (goButton) {
    goButton.disabled = active;
    goButton.setAttribute('aria-busy', active ? 'true' : 'false');
  }
  if (loadingIndicator) {
    loadingIndicator.classList.toggle('visible', active);
  }
}
if (toggleDebug && debugPanel) {
  toggleDebug.addEventListener('change', () => {
    debugPanel.classList.toggle('visible', toggleDebug.checked);
  });
}

if (goButton) {
  goButton.addEventListener('click', async () => {
    debug('Button clicked');
    setLoading(true);
    try {
      const fileInput = document.getElementById('file');
      const files = Array.from(fileInput?.files || []);
      if (!files.length) {
        debug('No files selected');
        return;
      }

      for (const f of files) {
        debug('Processing file: ' + f.name + ' (type=' + (f.type || 'unknown') + ')');

        // Skip obviously non-PDF files (but allow aliases/symlinks by checking name too)
        if (!/\.pdf$/i.test(f.name) && f.type !== 'application/pdf') {
          debug('Skipping non-PDF file: ' + f.name);
          continue;
        }
        try {
          const buf = await f.arrayBuffer();
          // Make a copy for PDFLib so pdfjs can safely detach/transfer the original buffer
          const pdfLibBuf = buf.slice(0);
          debug('ArrayBuffer ok, loading PDF');

          let src;
          try {
            src = await pdfjsLib.getDocument({ data: buf }).promise;
            debug('PDF loaded successfully');
          } catch (e) {
            debug('getDocument failed: ' + e);
            continue;
          }

          let count = src.numPages;
          debug('Page count: ' + count);

          // Special case: a single-page PDF should pass through as-is (A4, no imposition)
          if (count === 1) {
            debug('Single page input – passing through as A4');
            const orig = await PDFLib.PDFDocument.load(pdfLibBuf);
            const out = await PDFLib.PDFDocument.create();
            const [page] = await out.copyPages(orig, [0]);
            out.addPage(page);

            debug('Saving passthrough PDF');
            const bytes = await out.save();
            const blob = new Blob([bytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = f.name.replace(/\.pdf$/i, '') + '_a4.pdf';
            a.click();

            debug('Done with single-page file');
            continue;
          }

          function imposedPairs(n) {
            if (n === 2) return [[1, 0]];
            const pad = n % 4 === 0 ? 0 : 4 - (n % 4);
            const total = n + pad;
            const arr = [];
            let L = 0;
            let R = total - 1;
            while (L < R) {
              arr.push([R, L]);
              L++; R--;
              arr.push([L, R]);
              L++; R--;
            }
            return arr;
          }

          const out = await PDFLib.PDFDocument.create();
          const A3w = 1190.55;
          const A3h = 841.89;

          const rendered = [];
          const baseName = f.name.replace(/\.pdf$/i, '');
          const coverLabel = baseName.replace(/[_-]+/g, ' ').replace(/\s+/g, ' ').trim() || baseName || 'Booklet';
          for (let i = 1; i <= count; i++) {
            debug('Rendering page ' + i);
            const p = await src.getPage(i);
            const viewport = p.getViewport({ scale: 2 });
            const c = document.createElement('canvas');
            c.width = viewport.width;
            c.height = viewport.height;
            const ctx = c.getContext('2d');
            await p.render({ canvasContext: ctx, viewport }).promise;
            rendered.push(c);
            debug('Rendered page ' + i);
          }

          if (count === 2) {
            debug('Inserting cover page for two-page input');
            const template = rendered[0] || rendered[1];
            const coverCanvas = document.createElement('canvas');
            coverCanvas.width = template ? template.width : 1190;
            coverCanvas.height = template ? template.height : 842;
            const coverCtx = coverCanvas.getContext('2d');
            coverCtx.fillStyle = '#ffffff';
            coverCtx.fillRect(0, 0, coverCanvas.width, coverCanvas.height);
            coverCtx.fillStyle = '#000000';
            coverCtx.textAlign = 'left';
            coverCtx.textBaseline = 'top';

            // Position title in top right corner with wrapping
            const rightHalfStart = coverCanvas.width / 2;
            const padding = coverCanvas.width * 0.05; // 5% padding
            const maxWidth = (coverCanvas.width / 2) - (padding * 2); // Right half width minus padding
            let fontSize = Math.min(coverCanvas.width, coverCanvas.height) * 0.08; // Smaller initial font size
            
            // Find optimal font size
            coverCtx.font = `bold ${fontSize}px sans-serif`;
            const words = coverLabel.split(' ');
            let lines = [];
            let currentLine = '';
            
            // Wrap text into lines
            for (const word of words) {
              const testLine = currentLine ? `${currentLine} ${word}` : word;
              const metrics = coverCtx.measureText(testLine);
              if (metrics.width > maxWidth && currentLine) {
                lines.push(currentLine);
                currentLine = word;
              } else {
                currentLine = testLine;
              }
            }
            if (currentLine) {
              lines.push(currentLine);
            }
            
            // Draw wrapped text in top right corner
            const lineHeight = fontSize * 1.2;
            const startX = rightHalfStart + padding;
            const startY = padding;
            
            lines.forEach((line, index) => {
              coverCtx.fillText(line, startX, startY + (index * lineHeight));
            });
            
            rendered.unshift(coverCanvas);
            count = rendered.length;
          }

          const pairs = count === 1 ? [[0, -1]] : imposedPairs(count);
          debug('Pairs: ' + JSON.stringify(pairs));

          debug('Creating imposed output pages');

          for (let i = 0; i < pairs.length; i++) {
            const [L, R] = pairs[i];
            const page = out.addPage([A3w, A3h]);

            if (L >= 0 && L < count) {
              debug('Drawing left page ' + L);
              const img = await out.embedPng(rendered[L].toDataURL());
              const maxW = A3w / 2;
              const maxH = A3h;
              const s = Math.min(maxW / img.width, maxH / img.height);
              const drawW = img.width * s;
              const drawH = img.height * s;
              const x = (maxW - drawW) / 2;
              const y = (maxH - drawH) / 2;
              page.drawImage(img, { x, y, width: drawW, height: drawH });
            }

            if (R >= 0 && R < count) {
              debug('Drawing right page ' + R);
              const img = await out.embedPng(rendered[R].toDataURL());
              const maxW = A3w / 2;
              const maxH = A3h;
              const s = Math.min(maxW / img.width, maxH / img.height);
              const drawW = img.width * s;
              const drawH = img.height * s;
              const x = A3w / 2 + (maxW - drawW) / 2;
              const y = (maxH - drawH) / 2;
              page.drawImage(img, { x, y, width: drawW, height: drawH });
            }

            // This sets the page rotation metadata for printing
            if (i % 2 === 1) {
              page.setRotation(PDFLib.degrees(180));
            }
          }

          debug('Saving PDF');
          const bytes = await out.save();
          const blob = new Blob([bytes], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = f.name.replace(/\.pdf$/i, '') + '_booklet.pdf';
          a.click();

          debug('Done with file');
        } catch (e) {
          debug('Fatal error: ' + e);
        }
      }
    } finally {
      setLoading(false);
    }
  });
}
</script>
</body>
</html>
